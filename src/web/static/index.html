<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BoxedIn Agent</title>
  <script>
    // Guard against duplicate custom element definitions (some preview overlays inject scripts twice)
    (function(){
      try {
        const orig = customElements.define.bind(customElements);
        customElements.define = (name, ctor, options) => {
          if (customElements.get(name)) return; // ignore duplicates
          return orig(name, ctor, options);
        };
      } catch {}
    })();
  </script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background: #0b0f14; color: #e6edf3; }
    header { padding: 12px 16px; background: #111826; border-bottom: 1px solid #1f2937; }
    main { padding: 16px; display: grid; grid-template-columns: 420px 1fr; gap: 16px; }
    .card { background: #0f1622; border: 1px solid #1f2937; border-radius: 8px; padding: 12px; }
    .row { display: flex; gap: 8px; }
    input[type=text] { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #334155; background: #0b1320; color: #e6edf3; }
    button { padding: 10px 14px; border-radius: 6px; border: 1px solid #334155; background: #1b2432; color: #e6edf3; cursor: pointer; }
    pre { background: #0b1320; border: 1px solid #334155; padding: 10px; border-radius: 6px; overflow: auto; }
    .tag { display: inline-block; font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-right: 6px; background: #1b2432; border:1px solid #334155; }
    .log { height: 240px; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .tools { max-height: 240px; overflow: auto; }
  </style>
</head>
<body>
  <header>
    <h2>BoxedIn Agent</h2>
  </header>
  <main>
    <section class="card">
      <h3>Goal</h3>
      <div class="row">
        <input id="goal" type="text" placeholder="Describe your goal..." />
        <button id="run">Run</button>
      </div>
      <div style="margin-top:8px; display:flex; align-items:center; gap:12px;">
        <label><input type="checkbox" id="allowNetwork" /> Allow network</label>
        <small style="opacity:.8">When enabled, tools may install packages and access the internet inside the sandbox.</small>
      </div>
      <div style="margin-top:12px">
        <span class="tag">Model: <span id="model">gemini-1.5-flash</span></span>
        <span class="tag">Docker: <span id="docker">checking...</span></span>
      </div>
      <h3 style="margin-top:16px">Plan</h3>
      <pre id="plan"></pre>
      <h3>Answer</h3>
      <pre id="summary"></pre>
      <h3>Live Logs</h3>
      <pre id="logs" class="log"></pre>
      <details style="margin-top:8px">
        <summary>Details</summary>
        <h4>Plan</h4>
        <pre id="plan"></pre>
        <h4>Created Tools</h4>
        <div id="tools" class="tools"></div>
        <h4>Final Result (raw)</h4>
        <pre id="result"></pre>
      </details>
    </section>
    <section class="card">
      <h3>Tool Registry</h3>
      <div id="registry"></div>
    </section>
  </main>
  <script>
    const logs = document.getElementById('logs');
    const plan = document.getElementById('plan');
    const tools = document.getElementById('tools');
  const result = document.getElementById('result');
  const summary = document.getElementById('summary');
    const registry = document.getElementById('registry');

    function appendLog(text) {
      logs.textContent += text;
      logs.scrollTop = logs.scrollHeight;
    }

    function addToolCard(tool) {
      const div = document.createElement('div');
      div.className = 'card';
      div.style.margin = '8px 0';
      div.innerHTML = `<strong>${tool.name}</strong> <small>[${tool.id}]</small><br>
        <span class="tag">${tool.language}</span> entry: <code>${tool.entry}</code><br>
        <em>${tool.purpose || ''}</em>`;
      tools.appendChild(div);
    }

    async function refreshRegistry() {
      try {
        const list = await fetch('/api/tools').then(r => r.json());
        registry.textContent = list.map(t => `• ${t.name} [${t.id}] (${t.language}) → ${t.entry}`).join('\n');
      } catch { registry.textContent = '(failed to load)'; }
    }
    refreshRegistry();

  async function runFallback(goal, btn) {
      try {
  const res = await fetch('/api/run', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ goal, network: document.getElementById('allowNetwork').checked }) });
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : undefined; } catch { data = undefined; }
    if (!res.ok) throw new Error((data && data.error) || text || ('HTTP ' + res.status));
    const { final, logs: entries } = data || {};
        const p = entries.find(e => e.type === 'plan');
        if (p) plan.textContent = typeof p.plan?.plan === 'string' ? p.plan.plan : JSON.stringify(p.plan, null, 2);
        for (const e of entries) {
          if (e.type === 'runStart') appendLog(`\n[${e.info.id}] start args=${JSON.stringify(e.info.args)}\n`);
          if (e.type === 'runChunk') appendLog(e.info.chunk);
          if (e.type === 'runEnd') appendLog(`\n[${e.info.id}] end code=${e.info.code}\n`);
        }
  summary.textContent = final.answer || '';
  result.textContent = JSON.stringify(final, null, 2);
        refreshRegistry();
      } catch (err) {
    appendLog('\nError: ' + (err?.message || String(err)) + '\n');
      } finally { btn.disabled = false; }
    }

    document.getElementById('run').onclick = async () => {
      const btn = document.getElementById('run');
      btn.disabled = true;
      logs.textContent = '';
      tools.innerHTML = '';
      plan.textContent = '';
      result.textContent = '';
      const goal = document.getElementById('goal').value.trim();
      if (!goal) { btn.disabled = false; return; }

      let es;
      try {
        const allow = document.getElementById('allowNetwork').checked ? '&network=1' : '';
        es = new EventSource('/api/run-stream?goal=' + encodeURIComponent(goal) + allow);
      } catch { es = null; }
      if (!es) return runFallback(goal, btn);

      es.addEventListener('plan', (e) => {
        const data = JSON.parse(e.data);
        plan.textContent = typeof data.plan === 'string' ? data.plan : JSON.stringify(data, null, 2);
      });
      es.addEventListener('createTools', (e) => {
        try { JSON.parse(e.data).forEach(addToolCard); } catch {}
      });
      es.addEventListener('runStart', (e) => {
        const info = JSON.parse(e.data);
        appendLog(`\n[${info.id}] start args=${JSON.stringify(info.args)}${info.stdinPreview? ' stdin: ' + JSON.stringify(info.stdinPreview): ''}\n`);
      });
      es.addEventListener('runChunk', (e) => {
        const info = JSON.parse(e.data);
        appendLog(info.chunk);
      });
      es.addEventListener('runEnd', (e) => {
        const info = JSON.parse(e.data);
        appendLog(`\n[${info.id}] end code=${info.code}\n`);
      });
  es.addEventListener('result', (e) => {
        const data = JSON.parse(e.data);
        summary.textContent = (data && data.answer) || '';
        result.textContent = JSON.stringify(data, null, 2);
      });
      es.addEventListener('done', () => { try { es.close(); } catch {}; btn.disabled = false; refreshRegistry(); });
      es.addEventListener('complete', () => { try { es.close(); } catch {}; btn.disabled = false; refreshRegistry(); });
      es.addEventListener('error', (e) => {
        try { es.close(); } catch {}
        // Try to show a meaningful message if possible
        appendLog('\nSSE error. Falling back to JSON...\n');
        runFallback(goal, btn);
      });
    };
  </script>
</body>
</html>
